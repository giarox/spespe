name: scrape-lidl

on:
  workflow_dispatch:
  schedule:
    - cron: '17 * * * *'

jobs:
  run-scraper:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
      LIDL_STORAGE_STATE_B64: ${{ secrets.LIDL_STORAGE_STATE_B64 }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install root deps
        run: pnpm install
      - name: Install scraper deps
        working-directory: scraper
        run: pnpm install
      - name: Install Playwright
        working-directory: scraper
        run: npx playwright install chromium
      - name: Write storage state
        if: ${{ env.LIDL_STORAGE_STATE_B64 != '' }}
        working-directory: scraper
        run: echo "$LIDL_STORAGE_STATE_B64" | base64 -d > lidl-storage.json
      - name: Run scraper
        working-directory: scraper
        env:
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ env.SUPABASE_SERVICE_ROLE }}
          LIDL_STORAGE_STATE: ${{ env.LIDL_STORAGE_STATE_B64 != '' && 'lidl-storage.json' || '' }}
        run: |
          if [ -f lidl-storage.json ]; then export LIDL_STORAGE_STATE=lidl-storage.json; fi
          pnpm start
