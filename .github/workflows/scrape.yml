name: scrape-lidl

on:
  workflow_dispatch:
  schedule:
    # 07:00 Europe/Rome â‰ˆ 05:00 UTC (runs once daily)
    - cron: '0 5 * * *'

jobs:
  run-scraper:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
      LIDL_HUB_URL: https://www.lidl.it/c/volantino-lidl/s10018048
      LIDL_MAX_FLYERS: 1
      LIDL_MAX_PAGES: 6
      LIDL_DEVICE_SCALE_FACTOR: 2
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install pnpm
        run: npm install -g pnpm@9
      - name: Install root deps
        run: pnpm install
      - name: Install scraper deps
        working-directory: scraper
        run: pnpm install
      - name: Install Playwright
        working-directory: scraper
        run: npx playwright install chromium
      - name: Run scraper
        working-directory: scraper
        env:
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ env.SUPABASE_SERVICE_ROLE }}
        run: |
          export LIDL_STORAGE_STATE=lidl-storage.json
          pnpm start
