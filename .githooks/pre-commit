#!/bin/bash
# Pre-commit hook to prevent committing secrets
# Install: git config core.hooksPath .githooks

set -e

echo "[Security Check] Scanning for secrets..."

# Patterns that should never be committed
FORBIDDEN_PATTERNS=(
    "sk-or-v1-[a-zA-Z0-9]"           # OpenRouter API keys
    "github_pat_[a-zA-Z0-9]"          # GitHub PATs
    "ghp_[a-zA-Z0-9]"                 # GitHub personal access tokens
    "ssh-[a-z]* [A-Za-z0-9+/]"        # SSH keys
    "-----BEGIN RSA PRIVATE KEY"       # RSA private keys
    "-----BEGIN OPENSSH PRIVATE KEY"   # OpenSSH private keys
    "-----BEGIN EC PRIVATE KEY"        # EC private keys
    "aws_access_key_id"                # AWS access keys
    "aws_secret_access_key"            # AWS secret keys
    "password.*="                      # Password assignments
    "secret.*="                        # Secret assignments
    "api[_-]?key.*="                   # API key assignments
)

# Check staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

FOUND_SECRETS=0

for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
    if git diff --cached -U0 | grep -i "^\+.*$pattern" | grep -v "^+++" | grep -v "YOUR_" | grep -v "example\|Example\|EXAMPLE"; then
        echo "‚ùå BLOCKED: Potential secret detected matching pattern: $pattern"
        FOUND_SECRETS=1
    fi
done

# Check for .env files
for file in $STAGED_FILES; do
    if [[ "$file" =~ ^\.env[^/]*$ ]] && [[ "$file" != ".env.example" ]] && [[ "$file" != ".env.local.example" ]]; then
        echo "‚ùå BLOCKED: Attempting to commit $file (contains secrets)"
        FOUND_SECRETS=1
    fi
done

if [ $FOUND_SECRETS -eq 1 ]; then
    echo ""
    echo "üõë COMMIT BLOCKED - Potential secrets detected!"
    echo ""
    echo "What to do:"
    echo "  1. Remove sensitive data from staged files"
    echo "  2. Add secrets to .env or .env.local instead"
    echo "  3. Use GitHub Actions secrets for sensitive values"
    echo "  4. Add new patterns to .githooks/pre-commit if needed"
    echo ""
    echo "If this is a false positive, you can skip this hook with:"
    echo "  git commit --no-verify  (NOT RECOMMENDED)"
    echo ""
    exit 1
fi

echo "‚úÖ No secrets detected"
exit 0
